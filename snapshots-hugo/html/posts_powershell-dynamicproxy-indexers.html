<!DOCTYPE html><html lang="en"><head><script type="text/javascript" async="" src="https://www.google-analytics.com/analytics.js"></script><script type="text/javascript" async="" src="https://www.googletagmanager.com/gtag/js?id=G-46LYETW5NE&amp;cx=c&amp;gtm=4e6240"></script><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant="" defer=""></script>
    <meta charset="utf-8">
    <title>The curious case of PowerShell, Castle DynamicProxy and indexers | void where_prohibited() { ... }</title>
    <meta name="description" content="A personal website for Matt Kotsenas">
    <meta name="HandheldFriendly" content="True">
    
    <meta property="og:title" content="The curious case of PowerShell, Castle DynamicProxy and indexers | void where_prohibited() { ... }">
    <meta property="og:description" content="A personal website for Matt Kotsenas">
    <meta property="og:type" content="article">
    <meta property="og:url" content="http://localhost:1313/posts/powershell-dynamicproxy-indexers/">
    <meta property="og:image" content="http://localhost:1313/img/cover.jpg">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="The curious case of PowerShell, Castle DynamicProxy and indexers | void where_prohibited() { ... }">
    <meta name="twitter:description" content="A personal website for Matt Kotsenas">
    <meta name="twitter:image" content="http://localhost:1313/img/cover.jpg">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="stylesheet" href="/css/screen.css">
    <link rel="stylesheet" href="/css/hljs.css">
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400">
    <link rel="stylesheet" href="/css/custom.css">
    <link rel="alternate" type="application/rss+xml" title="void where_prohibited() { ... }" href="/rss.xml">
    <link rel="me" href="https://hachyderm.io/@mattkotsenas">
    
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-8867357-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-8867357-1');
    </script>
    
  <style id="fit-vids-style">.fluid-width-video-wrapper{width:100%;position:relative;padding:0;}.fluid-width-video-wrapper iframe,.fluid-width-video-wrapper object,.fluid-width-video-wrapper embed {position:absolute;top:0;left:0;width:100%;height:100%;}</style></head>
  <body class="post-template nav-closed">
    <div class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="#" class="nav-close">
      <span class="hidden">Close</span>
    </a>
    <ul>
      <li class="nav-any" role="presentation">
        <a href="/">Home</a>
      </li>
      <li class="nav-any" role="presentation">
        <a href="/about">About</a>
      </li>
      <li class="nav-any" role="presentation">
        <a href="/photos">Photos</a>
      </li>
    </ul>
    <a class="subscribe-button icon-feed" href="/rss.xml">Subscribe</a>
</div>
<span class="nav-cover"></span>

    <div class="site-wrapper">

      
<header class="main-header post-head" style="background-image: url(/img/cover.jpg)">
  <nav class="main-nav overlay clearfix">
    
    <a class="blog-logo" href="/"><img src="/img/home.png" alt="void where_prohibited() { ... }"></a>
    
    <a class="menu-button icon-menu" href="#"><span class="word">Menu</span></a>
  </nav>
</header>


<main class="content" role="main">
  <article class="post">

    <header class="post-header">
      <h1 class="post-title">The curious case of PowerShell, Castle DynamicProxy and indexers</h1>
      <section class="post-meta">
        <time class="post-date" datetime="2016-July-19">19 July 2016</time>
        
        <a href="/tags/powershell/">powershell</a>, <a href="/tags/.net/">.net</a>
        
      </section>
    </header>

    <section class="post-content">
      <blockquote>
<p>UPDATE: This issue is now <a href="https://windowsserver.uservoice.com/forums/301869-powershell/suggestions/15425352--bug-castle-s-dynamicproxy-breaks-property-indexe?tracking_code=29201113a860fa7a2196756b8e488001">tracked in uservoice</a>. If it’s affecting you, please upvote!</p></blockquote>
<h2 id="prerequisites">Prerequisites</h2>
<p>As I usually like to do, here’s the prerequisites for the article. Instructions and techniques likely apply to other versions, but if you’re having problems replicating my results, ensure your environment matches.</p>
<ol>
<li>PowerShell 5 (comes with Windows 10)</li>
<li><a href="http://www.castleproject.org/projects/dynamicproxy/">Castle DynamicProxy</a> version 3.3.3 in your current working directory</li>
</ol>
<h2 id="the-problem">The Problem</h2>
<p>I seem to have hit some sort of edge case between the Castle Project’s <a href="http://www.castleproject.org/projects/dynamicproxy/">DynamicProxy</a> object and the binding / dispatching of method calls in PowerShell. When an object with an <a href="https://msdn.microsoft.com/en-us/library/6x16t2tx.aspx">indexer</a> is proxied, that object’s indexer is no longer available in PowerShell, however, the underlying <code>get_Item()</code> method is still available.</p>
<h2 id="the-setup">The Setup</h2>
<p>Here’s a simple scenario to showcase the issue. First we need an interface that has an indexer in it, along with a simple class that implements that interface</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#cf222e">public</span> <span style="color:#cf222e">interface</span> <span style="color:#1f2328">MyInterface</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">double</span> <span style="color:#cf222e">this</span><span style="color:#1f2328">[</span><span style="color:#cf222e">int</span> i<span style="color:#1f2328">]</span> <span style="color:#1f2328">{</span> <span style="color:#cf222e">get</span><span style="color:#1f2328">;</span> <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">public</span> <span style="color:#cf222e">class</span> <span style="color:#1f2328">MyClass</span> <span style="color:#1f2328">:</span> MyInterface
</span></span><span style="display:flex;"><span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">private</span> <span style="color:#cf222e">double</span><span style="color:#1f2328">[]</span> _array <span style="color:#1f2328">=</span> <span style="color:#cf222e">new</span> <span style="color:#1f2328">[]</span> <span style="color:#1f2328">{</span> <span style="color:#0550ae">1.1</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">2.2</span> <span style="color:#1f2328">};</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">public</span> <span style="color:#cf222e">double</span> <span style="color:#cf222e">this</span><span style="color:#1f2328">[</span><span style="color:#cf222e">int</span> i<span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">get</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> _array<span style="color:#1f2328">[</span>i<span style="color:#1f2328">];</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>This is the object we ultimately care about and want to expose to the world. Next we need a DyanmicProxy <code>IInterceptor</code> to proxy the object</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#cf222e">public</span> <span style="color:#cf222e">class</span> <span style="color:#1f2328">MyProxy</span> <span style="color:#1f2328">:</span> IInterceptor
</span></span><span style="display:flex;"><span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">public</span> <span style="color:#cf222e">void</span> Intercept<span style="color:#1f2328">(</span>IInvocation invocation<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        invocation<span style="color:#1f2328">.</span>Proceed<span style="color:#1f2328">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>This proxy does nothing but forward the call along, but it’s enough to trigger the behavior. Lastly, for convenience, we create a factory to create the objects for us</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#cf222e">public</span> <span style="color:#cf222e">static</span> <span style="color:#cf222e">class</span> <span style="color:#1f2328">MyFactory</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">public</span> <span style="color:#cf222e">static</span> MyInterface GetViaInterface<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">new</span> MyClass<span style="color:#1f2328">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">public</span> <span style="color:#cf222e">static</span> MyInterface GetViaProxy<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">var</span> generator <span style="color:#1f2328">=</span> <span style="color:#cf222e">new</span> ProxyGenerator<span style="color:#1f2328">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#1f2328">(</span>MyInterface<span style="color:#1f2328">)</span>generator<span style="color:#1f2328">.</span>CreateInterfaceProxyWithTarget<span style="color:#1f2328">(</span><span style="color:#cf222e">typeof</span><span style="color:#1f2328">(</span>MyInterface<span style="color:#1f2328">),</span> <span style="color:#cf222e">new</span> MyClass<span style="color:#1f2328">(),</span> <span style="color:#cf222e">new</span> MyProxy<span style="color:#1f2328">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>So now we can bring it all together with a small PowerShell script that does the following</p>
<ol>
<li>Loads our classes into the AppDomain</li>
<li>Creates an instance of <code>MyClass</code> three different ways</li>
<li>Directly via <code>New-Object</code></li>
<li>As an instance of <code>MyInterface</code> via the factory</li>
<li>As an instance of <code>MyInterface</code> wrapped with a proxy via the factory</li>
<li>Outputs the result of calling <code>$obj[1]</code> and <code>$obj.get_Item(1)</code> for each instance</li>
</ol>
<p>Here’s the script:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#953800">$assemblies</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">"Castle.Core, Version=3.3.0.0, Culture=neutral, PublicKeyToken=407dd0808d44fbdc"</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#953800">$source</span> <span style="color:#1f2328">=</span> <span style="color:#0a3069">@"
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">using System;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">using Castle.DynamicProxy;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">namespace Sample
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">{
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    public interface MyInterface
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    {
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        double this[int i] { get; }
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    }
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    public class MyClass : MyInterface
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    {
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        private double[] _array = new [] { 1.1, 2.2 };
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        public double this[int i]
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        {
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            get
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            {
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">                return _array[i];
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            }
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        }
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    }
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    public class MyProxy : IInterceptor
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    {
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        public void Intercept(IInvocation invocation)
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        {
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            invocation.Proceed();
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        }
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    }   
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    public static class MyFactory
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    {
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        public static MyInterface GetViaInterface()
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        {
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            return new MyClass();
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        }
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        public static MyInterface GetViaProxy()
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        {
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            var generator = new ProxyGenerator();
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            return (MyInterface)generator.CreateInterfaceProxyWithTarget(typeof(MyInterface), new MyClass(), new MyProxy());
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        }
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    }
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">}
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">"@</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6639ba">Add-Type</span> -Path <span style="color:#0a3069">"</span><span style="color:#953800">$pwd</span><span style="color:#0a3069">\Castle.Core.dll"</span>
</span></span><span style="display:flex;"><span><span style="color:#6639ba">Add-type</span> -ReferencedAssemblies <span style="color:#953800">$assemblies</span> -TypeDefinition <span style="color:#953800">$source</span> -Language CSharp
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">function</span><span style="color:#fff"> </span><span style="color:#6639ba">print</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">param</span><span style="color:#1f2328">(</span><span style="color:#953800">$Text</span><span style="color:#1f2328">,</span> <span style="color:#953800">$Obj</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#953800">$direct</span> <span style="color:#1f2328">=</span> <span style="color:#953800">$Obj</span><span style="color:#1f2328">[</span><span style="color:#0550ae">1</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#953800">$item</span> <span style="color:#1f2328">=</span> <span style="color:#953800">$Obj</span><span style="color:#1f2328">.</span>get_Item<span style="color:#1f2328">(</span><span style="color:#0550ae">1</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">echo </span><span style="color:#0a3069">"</span><span style="color:#953800">$Text</span><span style="color:#0a3069"> --&gt; </span><span style="color:#0a3069">`$</span><span style="color:#0a3069">Obj[1] = </span><span style="color:#953800">$direct</span><span style="color:#0a3069"> </span><span style="color:#0a3069">`t</span><span style="color:#0a3069"> </span><span style="color:#0a3069">`$</span><span style="color:#0a3069">Obj.get_Item(1) = </span><span style="color:#953800">$item</span><span style="color:#0a3069">"</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print <span style="color:#0a3069">"Direct construction"</span> <span style="color:#1f2328">(</span><span style="color:#6639ba">New-Object</span> Sample<span style="color:#1f2328">.</span>MyClass<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>print <span style="color:#0a3069">"      Via interface"</span> <span style="color:#1f2328">([</span><span style="color:#0550ae">Sample.MyFactory</span><span style="color:#1f2328">]::</span>GetViaInterface<span style="color:#1f2328">())</span>
</span></span><span style="display:flex;"><span>print <span style="color:#0a3069">"          Via proxy"</span> <span style="color:#1f2328">([</span><span style="color:#0550ae">Sample.MyFactory</span><span style="color:#1f2328">]::</span>GetViaProxy<span style="color:#1f2328">())</span>
</span></span></code></pre></div><p>which results in the following output</p>
<pre tabindex="0"><code>Direct construction --&gt; $Obj[1] = 2.2    $Obj.get_Item(1) = 2.2
      Via interface --&gt; $Obj[1] = 2.2    $Obj.get_Item(1) = 2.2
          Via proxy --&gt; $Obj[1] =        $Obj.get_Item(1) = 2.2
</code></pre><p>Note that in the proxy case using the indexer directly gives no result, but using the underlying <code>get_Item()</code> method (which is how the indexer is actually implemented) works fine.</p>
<p>Here’s the same sample setup in a C# console app</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#cf222e">using</span> <span style="color:#24292e">System</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">using</span> <span style="color:#24292e">Castle.DynamicProxy</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">namespace</span> <span style="color:#24292e">Sample</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">public</span> <span style="color:#cf222e">interface</span> <span style="color:#1f2328">MyInterface</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">double</span> <span style="color:#cf222e">this</span><span style="color:#1f2328">[</span><span style="color:#cf222e">int</span> i<span style="color:#1f2328">]</span> <span style="color:#1f2328">{</span> <span style="color:#cf222e">get</span><span style="color:#1f2328">;</span> <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">public</span> <span style="color:#cf222e">class</span> <span style="color:#1f2328">MyClass</span> <span style="color:#1f2328">:</span> MyInterface
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">private</span> <span style="color:#cf222e">double</span><span style="color:#1f2328">[]</span> _array <span style="color:#1f2328">=</span> <span style="color:#cf222e">new</span><span style="color:#1f2328">[]</span> <span style="color:#1f2328">{</span> <span style="color:#0550ae">1.1</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">2.2</span> <span style="color:#1f2328">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">public</span> <span style="color:#cf222e">double</span> <span style="color:#cf222e">this</span><span style="color:#1f2328">[</span><span style="color:#cf222e">int</span> i<span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">get</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">return</span> _array<span style="color:#1f2328">[</span>i<span style="color:#1f2328">];</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">public</span> <span style="color:#cf222e">class</span> <span style="color:#1f2328">MyProxy</span> <span style="color:#1f2328">:</span> IInterceptor
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">public</span> <span style="color:#cf222e">void</span> Intercept<span style="color:#1f2328">(</span>IInvocation invocation<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            invocation<span style="color:#1f2328">.</span>Proceed<span style="color:#1f2328">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">public</span> <span style="color:#cf222e">static</span> <span style="color:#cf222e">class</span> <span style="color:#1f2328">MyFactory</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">public</span> <span style="color:#cf222e">static</span> MyInterface GetViaInterface<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#cf222e">new</span> MyClass<span style="color:#1f2328">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">public</span> <span style="color:#cf222e">static</span> MyInterface GetViaProxy<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">var</span> generator <span style="color:#1f2328">=</span> <span style="color:#cf222e">new</span> ProxyGenerator<span style="color:#1f2328">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#1f2328">(</span>MyInterface<span style="color:#1f2328">)</span>generator<span style="color:#1f2328">.</span>CreateInterfaceProxyWithTarget<span style="color:#1f2328">(</span><span style="color:#cf222e">typeof</span><span style="color:#1f2328">(</span>MyInterface<span style="color:#1f2328">),</span> <span style="color:#cf222e">new</span> MyClass<span style="color:#1f2328">(),</span> <span style="color:#cf222e">new</span> MyProxy<span style="color:#1f2328">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">public</span>  <span style="color:#cf222e">class</span> <span style="color:#1f2328">Program</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">private</span> <span style="color:#cf222e">static</span> <span style="color:#cf222e">void</span> Print<span style="color:#1f2328">(</span><span style="color:#cf222e">string</span> text<span style="color:#1f2328">,</span> <span style="color:#cf222e">dynamic</span> obj<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">var</span> direct <span style="color:#1f2328">=</span> obj<span style="color:#1f2328">[</span><span style="color:#0550ae">1</span><span style="color:#1f2328">];</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">var</span> item <span style="color:#1f2328">=</span> obj<span style="color:#1f2328">.</span>get_Item<span style="color:#1f2328">(</span><span style="color:#0550ae">1</span><span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            Console<span style="color:#1f2328">.</span>WriteLine<span style="color:#1f2328">(</span><span style="color:#cf222e">string</span><span style="color:#1f2328">.</span>Format<span style="color:#1f2328">(</span><span style="color:#0a3069">"{0} --&gt; obj[1] = {1} \t obj.Item(1) = {2}"</span><span style="color:#1f2328">,</span> text<span style="color:#1f2328">,</span> direct<span style="color:#1f2328">,</span> item<span style="color:#1f2328">));</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">static</span> <span style="color:#cf222e">void</span> Main<span style="color:#1f2328">(</span><span style="color:#cf222e">string</span><span style="color:#1f2328">[]</span> args<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            Print<span style="color:#1f2328">(</span><span style="color:#0a3069">"Direct construction"</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">new</span> MyClass<span style="color:#1f2328">());</span>
</span></span><span style="display:flex;"><span>            Print<span style="color:#1f2328">(</span><span style="color:#0a3069">"      Via interface"</span><span style="color:#1f2328">,</span> MyFactory<span style="color:#1f2328">.</span>GetViaInterface<span style="color:#1f2328">());</span>
</span></span><span style="display:flex;"><span>            Print<span style="color:#1f2328">(</span><span style="color:#0a3069">"          Via proxy"</span><span style="color:#1f2328">,</span> MyFactory<span style="color:#1f2328">.</span>GetViaProxy<span style="color:#1f2328">());</span>
</span></span><span style="display:flex;"><span>            Console<span style="color:#1f2328">.</span>ReadKey<span style="color:#1f2328">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>and the corresponding output</p>
<pre tabindex="0"><code>Direct construction --&gt; obj[1] = 2.2     obj.Item(1) = 2.2
      Via interface --&gt; obj[1] = 2.2     obj.Item(1) = 2.2
          Via proxy --&gt; obj[1] = 2.2     obj.Item(1) = 2.2
</code></pre><p>In this case the indexer works as expected. Both samples try to run the same code, and the C# app uses the <code>dynamic</code> keyword to get the same late-binding used by PowerShell, but obviously something’s different.</p>
<h2 id="wrap-up">Wrap Up</h2>
<p>Of course as a workaround you can use <code>get_Item()</code> for now, but I’m hopeful for a <a href="https://windowsserver.uservoice.com/forums/301869-powershell/suggestions/15425352--bug-castle-s-dynamicproxy-breaks-property-indexe?tracking_code=29201113a860fa7a2196756b8e488001">fix</a>. Of course it’s always possible my setup is incorrect and I have a bug, so if that’s the case please let me know at <a href="https://twitter.com/MattKotsenas">@MattKotsenas</a>, or send a PR with fixes!</p>

    </section>

    <footer class="post-footer">

      
      <figure class="author-image">
        <a class="img" href="/" style="background-image: url(https://gravatar.com/avatar/13e6e96d176cd18ef232d054b8e65f55)"><span class="hidden">Matt Kotsenas's Picture</span></a>
      </figure>
      

      <section class="author">
        <h4><a href="/">Matt Kotsenas</a></h4>

        <div class="author-meta">
          
          <span class="author-location icon-location">Seattle, WA</span>
          
        </div>
      </section>

      <section class="share">
        <h4>Share / feeds</h4>
        <a class="icon-twitter" href="https://twitter.com/intent/tweet?text=The+curious+case+of+PowerShell%2C+Castle+DynamicProxy+and+indexers&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2fpowershell-dynamicproxy-indexers%2f" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
          <span class="hidden">Twitter</span>
        </a>
        <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2flocalhost%3a1313%2fposts%2fpowershell-dynamicproxy-indexers%2f" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
          <span class="hidden">Facebook</span>
        </a>
        <a class="icon-feed" href="/rss.xml">
          <span class="hidden">RSS</span>
        </a>
      </section>
      <section>
        <div>
          <em>
            Did I make a mistake? Do you have a better idea? Please, help make the web better by sending me corrections at <a class="icon-github" href="https://github.com/MattKotsenas/MattKotsenas"><span class="hidden">GitHub</span></a>.
          </em>
        </div>
      </section>
    </footer>

  </article>
</main>

<aside class="read-next">
  
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      
        
        <a class="read-next-story" style="background-image: url(/img/cover.jpg)" href="http://localhost:1313/posts/https-in-service-fabric-web-api/">
          <section class="post">
            <h2>HTTP &amp; HTTPS in Service Fabric Web API</h2>
            <p></p><h2 id="prerequisites">Prerequisites</h2>
<p>Before we start, here are the prerequisites for this article. These instructions were …</p>…<p></p>
          </section>
        </a>
      
      
        
        <a class="read-next-story prev" style="background-image: url(/img/wpa-marks/filter-to-marks.png)" href="http://localhost:1313/posts/using-wpa-to-analyze-performance-marks/">
          </a><section class="post"><a class="read-next-story prev" style="background-image: url(/img/wpa-marks/filter-to-marks.png)" href="http://localhost:1313/posts/using-wpa-to-analyze-performance-marks/">
            <h2>Using the Windows Performance Toolkit to analyze performance marks on Edge and Chrome</h2>
            <p></p></a><p><a class="read-next-story prev" style="background-image: url(/img/wpa-marks/filter-to-marks.png)" href="http://localhost:1313/posts/using-wpa-to-analyze-performance-marks/">I have a bit of a love / hate relationship with the </a><a href="https://docs.microsoft.com/en-us/windows-hardware/test/wpt/index">Windows Performance Toolkit</a>. It’s easy to …</p>…<p></p>
          </section>
        
      
    
  
    
  
    
  
    
  
    
  
</aside>


      <footer class="site-footer clearfix">
        <section class="copyright"><a href="/">void where_prohibited() { ... }</a> © 2026</section>
      </footer>

    </div>
    <script src="//code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="/js/jquery.fitvids.js"></script>
    <script src="/js/index.js"></script>
  

</body></html>